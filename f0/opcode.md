# Opcode spec

- ここでは、OSECPUのCPUコードを定義する。
- ベースとなるバックエンド命令セット: http://osecpu.osask.jp/wiki/?page0072
  - ここから、ソフトウエア的にCPUコードに変換して実行する。
  - 変換プログラムはCPUコードで記述し、ROMに格納する。
  - 変換時の留意点については [こちら](./back2cpu.md)を参照。
- 命令フォーマットの詳細については、以下のスプレッドシートに記述している。
  - https://docs.google.com/spreadsheets/d/1Mu7-vil4o_n7MA1vi8nemQ8nVOJB7aya1bV88G011OA/edit?usp=sharing

## 発生する可能性のある例外
- CPUは以下の例外を発生させる可能性がある。
  - 例外が発生した場合、CPUの動作は停止され、例外ポートに例外コードが出力される。
  - 将来的には、例外ハンドラ機能を用意するかもしれないが、現在は存在しない。
  
- #UD: 無効命令例外
- #SE: セキュリティ例外
- #DE: 除算例外

## 実行環境
- 32bit符号付き整数レジスタx64(R0-R3F)

- ポインタレジスタx64(P0-P3F)
  - 1エントリの構造(28bit)
  
|bit  |0 - 11     |12 - 27   |
|----:|:---------:|:--------:|
|field|LBID(12bit)|ofs(16bit)|

- ラベルテーブルx4096
  - 1エントリの構造(40bit)
  
|bit  |0 - 7    |8 - 23     |24-39     |
|----:|:-------:|:---------:|:--------:|
|field|typ(8bit)|base(16bit)|len(16bit)|

## 定数等
- メモリtypに指定可能な値は以下のとおりである。
  - バックエンド命令におけるtypフィールドのサブセット+Codeになっている。

|typ(Hex)|データ型   |
|--------|---------|
|0x00    |Undefined|
|0x01    |VPtr     |
|0x02    |SINT8    |
|0x03    |UINT8    |
|0x04    |SINT16   |
|0x05    |UINT16   |
|0x06    |SINT32   |
|0x07    |(UINT32) |
|0x08    |SINT4    |
|0x09    |UINT4    |
|0x0A    |SINT2    |
|0x0B    |UINT2    |
|0x0C    |SINT1    |
|0x0D    |UINT1    |
|0x86    |Code     |

- 上記以外の値がtypに指定された場合は無効命令例外(#UD)が発生する。
- 32bit OSECPUでは、32ビット符号なし整数は指定できない。
- 



## 01: LBSET
### オペランド
- typ: データタイプ
- base: 符号なし整数
- count: 符号なし整数

### 動作
- メモリのbase番地を開始点として、typのデータがcount個存在するようなラベルを定義する。

## 02: LIMM16
### オペランド
- r: 整数レジスタ番号
- imm16: 16bit符号あり整数

### 動作
- r = imm16
- imm16は符号拡張されてから代入される。


## 03: PLIMM
### オペランド
- p: ポインタレジスタ番号
- LBID: 符号なし16bit整数

### 動作
- ポインタレジスタpにラベル番号LBIDを代入する。ポインタのオフセットは0に初期化される。

## 04: CND
### オペランド
- r: 整数レジスタ番号
### 動作
- 後続する1命令の実行を整数レジスタrの内容に応じてスキップする。
  - レジスタrのLSBが1: 後続する1命令を実行する。
  - レジスタrのLSBが0: 後続する1命令は実行しない。

## 08: LMEM
### オペランド
- r: 整数レジスタ番号
- p: ポインタレジスタ番号
- typ: データタイプ
### 動作
- ポインタレジスタpが指す内容を整数レジスタrに代入する。
- ポインタレジスタpが指すラベルのデータ型はtypと一致しなければならない。
  - 一致しない場合はセキュリティ例外(#SE)が発生する。

## 09: SMEM
### オペランド
- r: 整数レジスタ番号
- p: ポインタレジスタ番号
- typ: データタイプ
### 動作
- 整数レジスタrの内容をポインタレジスタpが指す位置に書き込む。
- ポインタレジスタpが指すラベルのデータ型はtypと一致しなければならない。
  - 一致しない場合はセキュリティ例外(#SE)が発生する。


## 0A: PLMEM
### オペランド
- p0: ポインタレジスタ番号
- p1: ポインタレジスタ番号
- typ: データタイプ

### 動作
- p0が指すポインタ情報をp1に代入する。
- typはVPtrでなければならない。
  - そうでなければセキュリティ例外が発生する。

## 0B: PSMEM
### オペランド
- p0: ポインタレジスタ番号
- p1: ポインタレジスタ番号
- typ: データタイプ

### 動作
- ポインタp1に相当する情報をp0が指すメモリ領域に書き込む。
  - 書き込まれる情報には、ポインタのオフセットも含まれる。
- typはVPtrでなければならない。
  - そうでなければセキュリティ例外が発生する。

## 0E: PADD
### オペランド
- r: 整数レジスタ番号
- p0: ポインタレジスタ番号
- p1: ポインタレジスタ番号
- typ: データタイプ

### 動作
- p0 = p1 + r 
- p1のオフセットにrを足したものをp0に代入する。
- typはp1の指すtypと一致していなければならない。
  - そうでなければセキュリティ例外が発生する。

## 0F: PDIF
### オペランド
- r: 整数レジスタ番号
- p0: ポインタレジスタ番号
- p1: ポインタレジスタ番号
- typ: データタイプ
### 動作
- r = p0 - p1 
- p0のオフセットからp1のオフセットを引いた結果を整数レジスタrに代入する。
- typはp1およびp0のtypと一致していなければならない。
  - そうでなければセキュリティ例外が発生する。

## 10-12: OR, XOR, AND
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = r1 | r2
- r0 = r1 ^ r2
- r0 = r1 & r2
- ビットごとの論理演算を行う。

## 14-15: ADD, SUB
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = r1 + r2
- r0 = r1 - r2
- 符号付き整数として演算を行う。
- オーバーフロー/アンダーフローが発生した場合はセキュリティ例外が発生する。

## 16: MUL
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = r1 * r2
- オーバーフローが発生した場合はセキュリティ例外が発生する。

## 18-19: SHL, SAR
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = r1 << r2
- r0 = r1 >> r2
- 右シフトは算術シフトで行われます。

## 1A-1B: DIV, MOD
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = r1 / r2
- r0 = r1 % r2
- r2が0の場合は除算例外(#DE)が発生する。


## 1E: PCP
### オペランド
- p0, p1: ポインタレジスタ番号
### 動作
- p0 = p1
- p0のポインタの指す先を、p1のポインタと等しくする。

## 20-25: CMP(E|NE|L|GE|LE|G)
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = (r1 == r2)
- r0 = (r1 != r2)
- r0 = (r1 < r2)
- r0 = (r1 >= r2)
- r0 = (r1 <= r2)
- r0 = (r1 > r2)

- r0には右辺の真偽値(真ならば1, 偽ならば0)が代入される。

## 26-27: TST(Z|NZ)
### オペランド
- r0, r1, r2: 整数レジスタ番号
### 動作
- r0 = ((r1 & r2) == 0)
- r0 = ((r1 & r2) != 0)
- r0には右辺の真偽値(真ならば1, 偽ならば0)が代入される。

## 28-2D: PCMP(E|NE|L|GE|LE|G)
### オペランド
- r0: 整数レジスタ番号
- p1, p2: ポインタレジスタ番号
### 動作
- r0 = (p1.ofs == p2.ofs)
- r0 = (p1.ofs != p2.ofs)
- r0 = (p1.ofs <  p2.ofs)
- r0 = (p1.ofs >= p2.ofs)
- r0 = (p1.ofs <= p2.ofs)
- r0 = (p1.ofs >  p2.ofs)
- p1とp2が同一のラベルを参照していない場合はセキュリティ例外。
- r0には右辺の真偽値(真ならば1, 偽ならば0)が代入される。

## D0: LIMM32
### オペランド
- r: 整数レジスタ番号
- imm32: 32ビット符号付き即値

### 動作
- r = imm32

